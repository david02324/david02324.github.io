<!DOCTYPE html><html lang="ko-KR" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="prefer-datetime-locale" content="ko"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="무료 사이드 프로젝트에서 Scalable 하게 프로덕션까지 fly.io 활용하기 A to Z" /><meta property="og:locale" content="ko_KR" /><meta name="description" content="fly.io" /><meta property="og:description" content="fly.io" /><link rel="canonical" href="https://blog.jangdaw.it/posts/fly-io/" /><meta property="og:url" content="https://blog.jangdaw.it/posts/fly-io/" /><meta property="og:site_name" content="David’s tech blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-09-26T00:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="무료 사이드 프로젝트에서 Scalable 하게 프로덕션까지 fly.io 활용하기 A to Z" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="-1qWyBGSOHrgveoJ1qU7bTALt0m0Cg-yuHpBYEZmk44" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-10-02T16:13:50+09:00","datePublished":"2023-09-26T00:00:00+09:00","description":"fly.io","headline":"무료 사이드 프로젝트에서 Scalable 하게 프로덕션까지 fly.io 활용하기 A to Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.jangdaw.it/posts/fly-io/"},"url":"https://blog.jangdaw.it/posts/fly-io/"}</script><title>무료 사이드 프로젝트에서 Scalable 하게 프로덕션까지 fly.io 활용하기 A to Z | David's tech blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="David's tech blog"><meta name="application-name" content="David's tech blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/74395374?s=400&v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">David's tech blog</a></div><div class="site-subtitle font-italic">개발하며 배우는 것들을 기록합니다</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>홈</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>카테고리</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>태그</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>아카이브</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>정보</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/david02324" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['jangdawit','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> 홈 </a> </span> <span>무료 사이드 프로젝트에서 Scalable 하게 프로덕션까지 fly.io 활용하기 A to Z</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 포스트</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="검색..."> </span> <span id="search-cancel" >취소</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>무료 사이드 프로젝트에서 Scalable 하게 프로덕션까지 fly.io 활용하기 A to Z</h1><div class="post-meta text-muted"> <span> 게시 <em class="" data-ts="1695654000" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2023-09-26 </em> </span> <span> 업데이트 <em class="" data-ts="1696230830" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2023-10-02 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/david02324">David</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3814 단어"> <em>21 분</em>읽는 시간</span></div></div></div><div class="post-content"><p><img data-src="/../assets/img/fly-io/flyio-logo.png" alt="" data-proofer-ignore><em>fly.io</em></p><h1 id="서론">서론</h1><p>사이드 프로젝트 혹은 해커톤 등에서 열심히 코드를 작성하고 배포할 때가 되면, 항상 어떤 플랫폼 혹은 서비스를 이용하여 배포하여야 더 경제적인지, 더 나아간다면 장기적으로 관리하기 쉽고 Scale in/out 하기 쉬운지를 고려하게 된다. AWS를 사용하자니 AWS 에서 제공하는 방대한 기능은 사실 거의 필요 없고, 혹여나 잘못된 리소스 관리로 요금 폭탄을 맞을지 두려움에 떨게 된다. 이러한 고민을 한번이라도 해본 개발자라면, 작은 인스턴스에 한에 완전 무료를 제공하는 Heroku 의 이름을 들어봤을 것이다.</p><p>그러나 Heroku 가 정책을 변경하면서, 더이상 완전 무료로 본인이 만든 사이드 프로젝트를 배포할 수 없게 되었다. 그 대안책으로 떠오른 PaaS 로 <a href="https://fly.io">fly.io</a>가 있다.</p><p>본 포스트에서는 필자가 직접 사이드 프로젝트를 구성하면서 도커 파일 작성, fly.toml 작성, development, production 환경 분리 배포, Scale-out, 더 나아가 단순 VM 뿐만 아니라 fly.io 에서 제공하는 Upstash redis 및 LiteFS 에 대해서도 간단히 소개한다.</p><h2 id="왜-flyio-인가"><span class="mr-2">왜 fly.io 인가?</span><a href="#왜-flyio-인가" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Heroku 를 버리고 다른 플랫폼들을 함께 찾아보고 있을 때, 내가 fly.io 에 가장 큰 매력을 느꼈던 점들은 다음과 같다.</p><ul><li>작은 인스턴스 <strong>3개</strong>에 대한 <strong>평생 무료</strong> 제공(카드는 등록해야함)<li>도커 컨테이너를 통한 아주 간편한 배포와 직관적인 fly.toml 파일<li>거의 모든 기능을 포함하고 있는 fly ctl<li>무료 기본 도메인 및 인증서<li>정말 쉬운 Scale in/out<li>배포만 하면 따라오는 Grafana metric<li><strong>합리적인 가격 정책</strong></ul><p><del>광고 아닙니다</del></p><p>여러가지를 써놓았지만, 가장 관심이 있는 부분은 역시 가격일 것이다. 23년 9월 기준 fly.io 에서 제공하고 있는 <a href="https://fly.io/docs/about/pricing/#free-allowances">무료 사용량</a>은 다음과 같다.</p><p><img data-src="/../assets/img/fly-io/free-allowance.png" alt="" data-proofer-ignore><em>무료 제공량</em></p><p>최대 3개의 작은 인스턴스와 160GB 의 Outbound 데이터 전송량(Inbound 는 무료)을 제공한다. 이는 작은 사이드 프로젝트를 배포하기에 아주 충분하다고 생각된다.</p><p><img data-src="/../assets/img/fly-io/no-payment.png" alt="" data-proofer-ignore><em>추가로 23-09 기준 월 5달러 미만의 요금은 과금되지 않는다</em></p><h1 id="첫-배포하기">첫 배포하기</h1><h2 id="프로젝트-코드-작성"><span class="mr-2">프로젝트 코드 작성</span><a href="#프로젝트-코드-작성" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>먼저 fly.io 에 배포할 첫 프로젝트 코드를 작성한다. 본 포스트의 취지에 맞게 필자는 아주 간단한 수준의 ping API 를 받는 ping-go 어플리케이션을 Golang 으로 작성했다.</p><p>패키지 다운받는 과정을 Dockerfile 에 포함하기 위해 gin 프레임워크를 사용하여 작성했다. Go 프로젝트를 하나 생성하고 다음 명령어를 통해 gin 의존성을 설치한다.</p><p><code class="language-plaintext highlighter-rouge">go get -u github.com/gin-gonic/gin</code></p><p>이후 아주 간단한 수준의 ping API 를 받는 코드를 main.go 에 작성했다.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"github.com/gin-gonic/gin"</span>
	<span class="s">"net/http"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">router</span> <span class="o">:=</span> <span class="n">gin</span><span class="o">.</span><span class="n">Default</span><span class="p">()</span>

	<span class="n">router</span><span class="o">.</span><span class="n">GET</span><span class="p">(</span><span class="s">"/ping"</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">gin</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">StatusOK</span><span class="p">,</span> <span class="s">"pong"</span><span class="p">)</span>
	<span class="p">})</span>
	
	<span class="n">router</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="s">":8080"</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>빌드 후 실행 파일을 실행해 보면 <code class="language-plaintext highlighter-rouge">/ping</code> 요청에 대해 잘 응답하는것을 확인할 수 있다.</p><p><img data-src="/../assets/img/fly-io/execute-binary.png" alt="" data-proofer-ignore><em>실행 모습</em></p><h2 id="도커파일-작성"><span class="mr-2">도커파일 작성</span><a href="#도커파일-작성" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>이제 이 프로젝트를 컨테이너 위에 올려서 배포하기 위한 Dockerfile 을 작성한다.</p><p><a href="https://fly.io/docs/languages-and-frameworks/">fly.io 공식 문서</a>에서는 Docker 뿐만 아니라 다양한 런타임을 직접 배포할 수 있는 방법을 소개한다. 다만 개인적으로 배포 환경의 관리 측면에서 Docker 가 편리하다고 생각하기에 Docker 로 예시를 들었다.</p><div class="language-Dockerfile highlighter-rouge"><div class="code-header"> <span data-label-text="Dockerfile"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">FROM</span><span class="s"> golang:1.19</span>

<span class="k">WORKDIR</span><span class="s"> /app</span>

<span class="k">COPY</span><span class="s"> . .</span>

<span class="k">RUN </span>go build <span class="nt">-o</span> main .

<span class="k">CMD</span><span class="s"> ["./main"]</span>

<span class="k">EXPOSE</span><span class="s"> 8080</span>
</pre></table></code></div></div><p>작은 Dockerfile을 하나 작성해주면 된다.</p><h2 id="fly-ctl-설치-및-배포"><span class="mr-2">fly ctl 설치 및 배포</span><a href="#fly-ctl-설치-및-배포" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>이제 <a href="https://fly.io">fly.io</a>에서 회원가입을 진행해주고, 카드를 하나 등록해준다.</p><p><img data-src="/../assets/img/fly-io/add-payment-method.png" alt="" data-proofer-ignore></p><p><em>무료 사용량을 사용하기 위해서 카드 등록이 필요하다. 유료 사용분을 사용하려고 하면 경고가 나오기 때문에 경험상 원치 않는 과금이 진행된 적은 없었다</em></p><p><img data-src="/../assets/img/fly-io/plan-hobby.png" alt="" data-proofer-ignore><em>카드 등록을 마치고 hobby 플랜으로 변경된 모습</em></p><p>여기까지 진행했으면, 이제 작성한 프로젝트를 배포한다. fly.io 플랫폼에서 할 수 있는 거의 모든 작업들은 <code class="language-plaintext highlighter-rouge">fly ctl</code> 을 통해 이루어진다.</p><p>MAC OS 기준 다음 명령어로 간단하게 설치할 수 있다.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c"># with homebrew</span>
brew <span class="nb">install </span>flyctl

<span class="c"># without homebrew</span>
curl <span class="nt">-L</span> https://fly.io/install.sh | sh
</pre></table></code></div></div><p>그 뒤 <code class="language-plaintext highlighter-rouge">fly auth login</code> 을 통해 터미널에서 fly.io 에 로그인 할 수 있다.</p><p>여기까지 진행되었다면 fly.io 를 사용할 준비는 완료되었다. 프로젝트 루트 폴더에서 다음 명령어를 실행한다.</p><p><code class="language-plaintext highlighter-rouge">fly launch</code></p><p><img data-src="/../assets/img/fly-io/fly-launch.png" alt="" width="70%" data-proofer-ignore></p><p>프로젝트 이름과, 리전 등을 묻는다. 2023-09 기준 서울 리전은 없고, 가장 가까운 <strong>Tokyo, Japan (nrt)</strong> 리전을 선택했다.</p><p><img data-src="/../assets/img/fly-io/fly-launch-2.png" alt="" width="70%" data-proofer-ignore></p><p>여기서 postgresql DB 를 바로 붙일지 묻는데, 여기서 y 를 택하면, secret 환경 변수 <code class="language-plaintext highlighter-rouge">DATABASE_URL</code> 에 postgresql 엔드포인트가 지정된다. 필요에 따라 지정하면 되겠다. 필자는 일단 붙이지 않았다.</p><p><img data-src="/../assets/img/fly-io/fly-launch-3.png" alt="" width="70%" data-proofer-ignore></p><p>몇가지 선택을 완료하면 해당 선택 내용을 바탕으로 <code class="language-plaintext highlighter-rouge">fly.toml</code> 을 생성해준다. 그리고 즉시 배포할지 묻는데, y 를 택하겠다.</p><p>이후 조금 기다리면, fly.io 의 remote builder 를 통해 dockerfile 을 빌드하고, 실행해준다. 첫 배포 시 ip 를 할당해주고, 머신을 띄우느라 조금 더 오래걸린다.</p><p><img data-src="/../assets/img/fly-io/fly-launch-done.png" alt="" width="70%" data-proofer-ignore></p><p>배포가 완료되면 바로 해당 어플리케이션에 진입할 수 있는 엔드포인트가 <strong>https://{projectName}.fly.dev/</strong> 형태로 제공된다.</p><p><img data-src="/../assets/img/fly-io/deploy-done.png" alt="" data-proofer-ignore></p><p>접속해보면 잘 동작하는것을 확인할 수 있다.</p><p>홈페이지 대시보드에 접속해보면, 내가 배포한 프로젝트가 생성되어 있는것을 볼 수 있는데 이를 선택하면 배포한 프로젝트의 실시간 로그나 지표, 인스턴스 개수 및 스케일 등을 확인할 수 있다.</p><p><img data-src="/../assets/img/fly-io/fly-dashboard.png" alt="" data-proofer-ignore></p><p>이후 배포에서는 간단하게 <code class="language-plaintext highlighter-rouge">fly deploy</code> 명령어를 사용하면 로컬 파일들을 기준으로 배포가 진행된다.</p><h2 id="도메인-설정"><span class="mr-2">도메인 설정</span><a href="#도메인-설정" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>처음 배포 시 <strong>https://{projectName}.fly.dev/</strong> 형태의 고정된 도메인을 받게 되는데, 원하는 도메인을 추가하기 위해서는 fly ctl 의 <a href="https://fly.io/docs/flyctl/certs-add/">fly certs 커맨드</a> 혹은 홈페이지 대시보드에서 추가할 수 있다.</p><p><img data-src="/../assets/img/fly-io/add-domain.png" alt="" data-proofer-ignore><em>홈페이지 대시보드에서 도메인 추가</em></p><p><em>기본적으로 부여해주는 도메인을 해제하는 방법은 찾지 못했다. 필자의 경우 기본 도메인으로 접근 시 추가한 도메인으로 리다이렉트 하는 코드를 하드코딩하는 방식으로 우회했다. 더 좋은 방법이 있다면 댓글로 남겨주시면 감사합니다!</em></p><h1 id="프로젝트-관리하기">프로젝트 관리하기</h1><p>드디어 프로젝트를 배포했다. 이제는 프로젝트를 유지/보수하면서 사용할 수 있는 fly.io 의 다양한 feature 들을 소개한다.</p><h2 id="flytoml"><span class="mr-2">fly.toml</span><a href="#flytoml" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>프로젝트 폴더에 보면 fly.toml 파일이 생성되어 있을 것이다. 이 파일은 <code class="language-plaintext highlighter-rouge">fly deploy</code>를 실행했을 때 보게 될 설정 파일이다. 따로 <code class="language-plaintext highlighter-rouge">--config</code> 플래그를 사용하지 않으면 기본 <code class="language-plaintext highlighter-rouge">fly.toml</code> 을 바라보게 된다.</p><div class="language-toml highlighter-rouge"><div class="code-header"> <span data-label-text="TOML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c"># fly.toml app configuration file generated for ping-go on 2023-09-30T07:03:49+09:00</span>
<span class="c">#</span>
<span class="c"># See https://fly.io/docs/reference/configuration/ for information about how to use this file.</span>
<span class="c">#</span>

<span class="py">app</span> <span class="p">=</span> <span class="s">"ping-go"</span>
<span class="py">primary_region</span> <span class="p">=</span> <span class="s">"nrt"</span>

<span class="nn">[build]</span>

<span class="nn">[http_service]</span>
  <span class="py">internal_port</span> <span class="p">=</span> <span class="mi">8080</span>
  <span class="py">force_https</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="py">auto_stop_machines</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="py">auto_start_machines</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="py">min_machines_running</span> <span class="p">=</span> <span class="mi">0</span>
  <span class="py">processes</span> <span class="p">=</span> <span class="nn">["app"]</span>
</pre></table></code></div></div><p>쓸만한 몇가지 옵션들을 보자면,</p><ul><li><a href="https://fly.io/docs/reference/configuration/#the-env-variables-section">env</a><ul><li>실행 환경 변수를 지정한다.<li>보통 git 저장소에 fly.toml 을 올리기에 이 섹션에 민감한 정보는 포함하면 안된다. 민감한 정보는 fly secrets 를 통해 주입하는것이 권장된다.</ul><li><a href="https://fly.io/docs/reference/configuration/#the-build-section">build</a><ul><li>빌드할 때 사용할 info 를 저장한다.<li>dockerfile, dockerignore, docker build arg 등을 지정할 수 있다.</ul><li><a href="https://fly.io/docs/reference/configuration/#the-deploy-section">deploy</a><ul><li><a href="https://fly.io/docs/reference/configuration/#picking-a-deployment-strategy">strategy 옵션</a>을 통해 배포 시 전략을 택할 수 있다! rolling, immediate, canary, bluegreen 이 있다.<li>기본 rolling 배포 전략이 수행된다.</ul><li><a href="https://fly.io/docs/reference/configuration/#the-processes-section">processes</a><ul><li>인스턴스 별 역할이 다를 때, 혹은 아예 다른 프로세스를 올려야 할 때 사용한다.<li>예를 들어 cron 만을 수행하는 단일 인스턴스를 API 를 담당하는 인스턴스와 분리하는 등의 경우 유용하다.<li><strong>scale in/out 시 따로 관리가 가능하다.</strong></ul></ul><h3 id="stage-분리-배포"><span class="mr-2">stage 분리 배포</span><a href="#stage-분리-배포" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>fly.toml 을 이용하여 development, production stage 를 간단하게 분리할 수 있다. 먼저 fly.toml 을 development 환경에 맞추어 설정하고, prod.fly.toml 을 생성하여 production 환경에 맞게 값을 세팅한다. 그리고 배포 시 <code class="language-plaintext highlighter-rouge">fly deploy --config prod.fly.toml</code> 을 통하여 production 배포가 가능하다.</p><h2 id="grafana"><span class="mr-2">Grafana</span><a href="#grafana" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><img data-src="/../assets/img/fly-io/grafana-icon.png" alt="" data-proofer-ignore></p><p>배포 시점부터 grafana 를 달아준다. Dashboard » project » Metrics » 우 상단 Grafana 아이콘을 선택하면 들어갈 수 있다.</p><p><img data-src="/../assets/img/fly-io/grafana.png" alt="" data-proofer-ignore></p><h2 id="scale-inout"><span class="mr-2">Scale in/out</span><a href="#scale-inout" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>머신의 수평적 확장 혹은 축소가 필요할 때 <code class="language-plaintext highlighter-rouge">fly scale</code> 커맨드를 통해 진행할 수 있다.</p><p>먼저 <code class="language-plaintext highlighter-rouge">fly scale show</code> 를 통해 현재 머신 수를 확인한다.</p><p><img data-src="/../assets/img/fly-io/scale-show.png" alt="" width="70%" data-proofer-ignore></p><p>위에서 본 fly.toml 의 processes 를 통해 프로세스를 나누어 두었다면, 단순 app 이 아니라 프로세스별로 표시될 것이다.</p><p>아주 간단하게 그냥 기본 프로세스의 머신 수를 조정하고 싶다면 <code class="language-plaintext highlighter-rouge">fly scale count</code> 를 사용하면 된다. fly.io 에서는 3개 머신까지 무료로 제공하므로, ping-go 의 app 프로세스를 3개로 늘려보겠다.</p><p><img data-src="/../assets/img/fly-io/scale-out.png" alt="" width="70%" data-proofer-ignore></p><p>간단하게 <code class="language-plaintext highlighter-rouge">fly scale count 3</code> 하면 된다. 몇 초 안걸려서 새로운 인스턴스가 뜬걸 확인할 수 있다.</p><p><img data-src="/../assets/img/fly-io/scale-out-done.png" alt="" width="70%" data-proofer-ignore></p><p>간단하게는 이렇게 수동으로 scaling 할 수 있다.</p><p>다만 트래픽이나 머신의 CPU rate 등을 통해 자동으로 scaling 하려면 <a href="https://fly.io/docs/flyctl/autoscale/">fly autoscale</a> 을 사용해야 하는데, 해당 기능이 fly machines V1 에서만 지원된다. 추후 V2 머신에서도 지원될 것으로 보인다.</p><h2 id="환경-변수-관리"><span class="mr-2">환경 변수 관리</span><a href="#환경-변수-관리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>환경 변수는 fly.io 에서 두 가지 방식으로 관리할 수 있다.</p><p>먼저 민감하지 않은 환경 변수(GO_ENV 같은)는 자연스럽게 git 에 포함되도록 fly.toml 의 env 섹션을 활용하는것을 추천한다. 예를 들어 다음과 같은 형태로 추가할 수 있다.</p><div class="language-toml highlighter-rouge"><div class="code-header"> <span data-label-text="TOML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nn">[env]</span>
  <span class="py">GO_ENV</span> <span class="p">=</span> <span class="s">"prod"</span>
  <span class="py">HOST_NAME</span> <span class="p">=</span> <span class="s">"https://ping-go.jangdaw.it"</span>
</pre></table></code></div></div><p>그리고 API_TOKEN과 같은 민감한 환경 변수의 경우 <code class="language-plaintext highlighter-rouge">fly secrets</code> 를 통해 따로 주입하는것을 추천한다.</p><p><code class="language-plaintext highlighter-rouge">fly secrets --app {projectName} set ENV=VALUE</code> 형태로 사용할 수 있다.</p><p><img data-src="/../assets/img/fly-io/secrets-set.png" alt="" width="70%" data-proofer-ignore></p><p>다만 secrets 을 변경하면 바로 어플리케이션이 재배포되기 때문에, 이를 피하고 싶다면 <code class="language-plaintext highlighter-rouge">--stage</code> 플래그를 추가하면 된다. 이러면 다음 배포때부터 적용된다.</p><p>환경 변수 적용 이후 <code class="language-plaintext highlighter-rouge">fly secrets --app {projectName} list</code> 를 통해 적용된 환경 변수명과 갱신 시점을 확인할 수 있다.</p><p><img data-src="/../assets/img/fly-io/secrets-done.png" alt="" width="70%" data-proofer-ignore></p><h1 id="써봄직한-기능들">써봄직한 기능들</h1><p>단순 VM 뿐만 아니라 fly.io 에서 제공하는 다른 integration 들을 소개한다.</p><h2 id="fly-postgres"><span class="mr-2">Fly postgres</span><a href="#fly-postgres" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>어플리케이션 배포에 RDBMS 하나정도는 필요할 확률이 높다. fly.io 에서는 강력한 SQL DB 인 postgresql 과의 편리한 통합을 제공한다.</p><p><em>fly postgres 는 AWS 의 DynamDB 와 같은 Managed service 는 아니다. 단순 VM 배포와 동일하게 취급(과금 등)되지만, 생성 및 DB 로써의 관리를 편리하게 하기 위한 추가적인 기능들이 마련되어 있을 뿐이다. 자세한 내용은 <a href="https://fly.io/docs/postgres/getting-started/what-you-should-know/">이곳</a></em></p><p>먼지 <code class="language-plaintext highlighter-rouge">fly postgres create</code> 를 통해 Postgres cluster 를 생성한다.</p><p><img data-src="/../assets/img/fly-io/fly-postgres-create.png" alt="" width="70%" data-proofer-ignore></p><p>개인적으로 DB 는 넉넉한 스펙을 선호하지만, 과금을 원치 않는다면 가장 작은 스펙으로 배포한다.</p><p><img data-src="/../assets/img/fly-io/postgres-done.png" alt="" width="70%" data-proofer-ignore></p><p>DB 생성 후 접근은 크게 3가지 방법이 있다.</p><ul><li><strong>fly VM 에서는</strong> username 과 password 를 통한 postgres url 을 사용 <code class="language-plaintext highlighter-rouge">postgres://{username}:{password}@{hostname}:{port}/{database}?options</code><li><code class="language-plaintext highlighter-rouge">fly postgres connect --app {appName}</code> 을 통해 터미널에서 직접 접근<li><code class="language-plaintext highlighter-rouge">fly proxy {port} --app {appName}</code> 을 통해 특정 포트를 proxy 로 하여금 접근</ul><blockquote><p>필자의 경우에는 DB에 직접 쿼리날려서 볼때는 <code class="language-plaintext highlighter-rouge">fly postgres connect</code> 를 사용했고, 마이그레이션을 수행할 때는 proxy 를 사용했다.</p></blockquote><p>이외 fly postgres 의 모니터링, 백업, config, 고가용성 및 복제 등 다양한 사용법에 대해서는 <a href="https://fly.io/docs/postgres/managing/">문서</a>에 자세하게 나와 있다.</p><h3 id="추가"><span class="mr-2">추가</span><a href="#추가" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><a href="https://fly.io/docs/postgres/getting-started/migrate-from-heroku/">Heroku postgres 로부터 migrate</a></ul><h2 id="upstash-redis"><span class="mr-2">Upstash redis</span><a href="#upstash-redis" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>단순 key/value store 부터 pub/sub message broker 등 다양한 역할을 수행하는 Redis 또한 fly 에서 지원한다. <code class="language-plaintext highlighter-rouge">fly redis create</code> 를 통해 아주~ 간단하게 작은 무료 redis 노드를 하나 얻을 수 있다.</p><p><img data-src="/../assets/img/fly-io/redis-create.png" alt="" width="70%" data-proofer-ignore></p><p>이 redis 도 postgresql 과 비슷하게 <code class="language-plaintext highlighter-rouge">fly redis connect</code> 로 직접 터미널에서 접근하거나 <code class="language-plaintext highlighter-rouge">redis://{username}:{password}@[{ipv6 address}]:{port}</code> 포멧을 통해 외부에서 접근할 수 있다.</p><p><img data-src="/../assets/img/fly-io/redis-connect.png" alt="" width="70%" data-proofer-ignore></p><p>다만 이 redis 는 upstash 에서 제공하는 redis 인스턴스로, 2023-09 기준 fly.io 의 experimental 기능이라서 production 에는 사용하는것이 권장되지 않는다.</p><p>그리고 실제로 사이드 프로젝트에서 사용했는데, 처음엔 잘되다가 얼마 지나니 connection 이 유실되는 케이스가 있었다.</p><h2 id="litefs"><span class="mr-2">LiteFS</span><a href="#litefs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>LiteFS 는 파일시스템 DB SQLite 를 분산 하여 응답성을 높이는 기술으로, 어플리케이션에서는 그냥 SQL DB 를 사용하는것처럼 사용하고 실제 요청이 들어왔을 때 복제된 가장 가까운 replica 에게서 조회하는 방식으로 동작한다.</p><p>필자도 실제로 fly.io 에서 이 기능을 사용해보진 않아서 이렇게 간단히 소개만 한다. 좀더 관심이 있다면 <a href="https://fly.io/docs/litefs/">문서</a>에서 확인하길 바란다.</p><h1 id="마무리">마무리</h1><p>프로젝트 배포 및 관리를 위한 fly.io 의 주요 기능들을 전체적으로 훑어보았다. 이외에도 fly ctl 을 통해 다양한 작업들이 가능하고 문서화도 잘 되어있어서 기회가 된다면 <a href="https://fly.io/docs/">문서</a>를 쭉 읽어보는것도 추천한다.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='//categories/infra/'>Infra</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="//tags/flyio/" class="post-tag no-text-decoration" >flyio</a> <a href="//tags/deploy/" class="post-tag no-text-decoration" >deploy</a> <a href="//tags/paas/" class="post-tag no-text-decoration" >PaaS</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 이 기사는 저작권자의 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 라이센스를 따릅니다.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">공유하기</span> <span class="share-icons"> <a href="https://www.facebook.com/sharer/sharer.php?title=%EB%AC%B4%EB%A3%8C+%EC%82%AC%EC%9D%B4%EB%93%9C+%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8%EC%97%90%EC%84%9C+Scalable+%ED%95%98%EA%B2%8C+%ED%94%84%EB%A1%9C%EB%8D%95%EC%85%98%EA%B9%8C%EC%A7%80+fly.io+%ED%99%9C%EC%9A%A9%ED%95%98%EA%B8%B0+A+to+Z+-+David%27s+tech+blog&u=https%3A%2F%2Fblog.jangdaw.it%2Fposts%2Ffly-io%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fblog.jangdaw.it%2Fposts%2Ffly-io%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="링크 복사하기" data-title-succeed="링크가 복사되었습니다!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">최근 업데이트</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/localstack-and-lambda/">localstack 으로 로컬 환경에서 lambda 개발 및 테스트 환경 구축하기</a><li><a href="/posts/fly-io/">무료 사이드 프로젝트에서 Scalable 하게 프로덕션까지 fly.io 활용하기 A to Z</a></ul></div><div id="access-tags"><div class="panel-heading">인기 태그</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/deploy/">deploy</a> <a class="post-tag" href="/tags/flyio/">flyio</a> <a class="post-tag" href="/tags/golang/">golang</a> <a class="post-tag" href="/tags/lambda/">lambda</a> <a class="post-tag" href="/tags/localstack/">localstack</a> <a class="post-tag" href="/tags/paas/">PaaS</a> <a class="post-tag" href="/tags/serverless/">serverless</a> <a class="post-tag" href="/tags/test/">test</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">바로가기</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>관련된 글</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/localstack-and-lambda/"><div class="card-body"> <em class="small" data-ts="1662130800" data-df="YYYY-MM-DD" > 2022-09-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>localstack 으로 로컬 환경에서 lambda 개발 및 테스트 환경 구축하기</h3><div class="text-muted small"><p> 서론 개발하다보면 가용성이나 여타 다른 서비스의 영향을 받지 않기 위해 서버리스 운영을 고려하곤 한다. AWS의 lambda 는 standalone 에 비해 상대적으로 개발하기 간편하면서 다른 인프라 의존성을 신경쓸 일이 적고(DB 접근같은 문제는 차치하더라도) 필요에 따라 훨씬 유연하게 개발할 수 있기 때문에 특정 상황에서 많은 장점을 가지고 있...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="//posts/localstack-and-lambda/" class="btn btn-outline-primary" prompt="이전 글"><p>localstack 으로 로컬 환경에서 lambda 개발 및 테스트 환경 구축하기</p></a><div class="btn btn-outline-primary disabled" prompt="다음 글"><p>-</p></div></div><script src="https://utteranc.es/client.js" repo="david02324/david02324.github.io" issue-term="title" crossorigin="anonymous" async> </script> <script type="text/javascript"> $(function() { const origin = "https://utteranc.es"; const iframe = "iframe.utterances-frame"; const lightTheme = "github-light"; const darkTheme = "github-dark"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } addEventListener("message", (event) => { let theme; /* credit to <https://github.com/utterance/utterances/issues/170#issuecomment-594036347> */ if (event.origin === origin) { /* page initial */ theme = initTheme; } else if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); } else { return; } const message = { type: "set-theme", theme: theme }; const utterances = document.querySelector(iframe).contentWindow; utterances.postMessage(message, origin); }); }); </script></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/david02324">David</a>. <span data-toggle="tooltip" data-placement="top" title="명시되지 않는 한 이 사이트의 블로그 게시물은 작성자의 Creative Commons Attribution 4.0 International(CC BY 4.0) 라이선스에 따라 사용이 허가되었습니다.">일부 권리 보유</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">인기 태그</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/deploy/">deploy</a> <a class="post-tag" href="/tags/flyio/">flyio</a> <a class="post-tag" href="/tags/golang/">golang</a> <a class="post-tag" href="/tags/lambda/">lambda</a> <a class="post-tag" href="/tags/localstack/">localstack</a> <a class="post-tag" href="/tags/paas/">PaaS</a> <a class="post-tag" href="/tags/serverless/">serverless</a> <a class="post-tag" href="/tags/test/">test</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">새 버전의 콘텐츠를 사용할 수 있습니다.</p><button type="button" class="btn btn-primary" aria-label="Update"> 업데이트 </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">검색 결과가 없습니다.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/ko.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
